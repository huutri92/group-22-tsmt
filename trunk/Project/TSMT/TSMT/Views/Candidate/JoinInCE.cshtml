@{
    ViewBag.Title = "Đăng ký vào hội từ thiện";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using TSMT.Models
@model IEnumerable<ChairitiesExam>

<link href="/Content/css/TSMTJoinInCE.css" rel="stylesheet"/>
<script src="/Content/js/jquery.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=geometry,places&sensor=false"></script>
<script src="/Content/js/TSMTJoinInCE.js"></script>

@{
    ExaminationsPaper ep = (ExaminationsPaper)ViewData["ep"];
    Venue ve = ep.Venue;
}

@section Breadcrumbs {
    <!--=== Breadcrumbs ===-->
    <div class="breadcrumbs margin-bottom-20">
        <div class="container">
            <h1 class="pull-left">@ViewBag.Title</h1>
            <ul class="pull-right breadcrumb">
                <li><a href="@Url.Action("Index", "Home")">Trang Chủ</a></li>
                <li><a href="@Url.Action("Index", "Candidate")">Thí sinh</a></li>
                <li><a href="@Url.Action("ManageExamPaper", "Candidate")">Thông tin phiếu báo thi</a></li>
                <li class="active">@ViewBag.Title</li>
            </ul>
        </div>
    </div>
}

@using (Html.BeginForm("JoinInCE", "Candidate", FormMethod.Post, new { id = "formJoinInCE" }))
{
    <div class="col-md-12 margin-bottom-5">
        <div class="panel panel-blue">
            <div class="panel-heading"  id="scrollToMe">
                <h3 class="panel-title"><i class="fa fa-user"></i>Thông tin phiếu báo thi</h3>
            </div>
            <input type="hidden" name="epId" value="@ep.ExamPaperID" />
            <input type="hidden" id="lodgeId" name="lodgeId" />
            <table class="table table-hover">
                <tr style="text-align: center">
                    <td style="vertical-align: middle">
                        <b>Kỳ thi: </b>@ep.UniversitiesExamination.Examination.Name </td>
                    <td style="vertical-align: middle"><b>Trường dự thi: </b>@ep.UniversitiesExamination.University.Name</td>
                    <td style="vertical-align: middle"><b>Địa điểm dự thi: </b>@ve.Address</td>
                    <td style="vertical-align: middle">
                        <button onclick="clickOnMarker('-1', true); return false;" class="btn-u btn-u-dark-blue margin-bottom-5"><i class="fa fa-map-marker"></i>&nbsp;Đi đến địa điểm thi</button>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="col-md-12">
        <div class="col-md-3">
            <div class="input-group margin-bottom-5">
                <table class="table">
                    <tr>
                        <td style="vertical-align: middle"><b>Tổ chức:</b>
                        </td>
                        <td>
                            <select id="ceId" name="ceId" onchange="changeCE(this.value)" class="form-control">
                                <option value="null">Tất cả</option>
                                @foreach (var item in Model)
                                {
                                    <option value="@item.CharityExamID">@item.Charity.Name</option>
                                }
                            </select></td>
                    </tr>
                     <tr>
                        <td><b>Bán kính: </b></td>
                        <td><div id="radius"></div></td>
                    </tr>
                     <tr>
                        <td colspan="2">
                            <p><strong>Danh sách chỗ trọ:</strong></p>
                        </td>
                    </tr>
                </table>
                <div id="examVenues"></div>
            </div>
        </div>
        <div class="col-md-9" id="map_canvas" style="height: 500px">
        </div>
    </div>
    
}

<script type="text/javascript">
    $(document).ready(function () {
        $('html').animate({scrollTop: $("#scrollToMe").offset().top - 20},'slow');
        createData();
        initialize(new google.maps.LatLng("@ve.Latitude", "@ve.Longitude"));
        createTheCircle();
        $("#ceId")[0].onchange();
    });

    function createData() {
        /* INIT VENUE */
        lodges[-1] = {
            lodgeId: -1,
            name: "@ve.Address",
            data: new google.maps.LatLng("@ve.Latitude", "@ve.Longitude"),
            description: "<strong>Địa điểm thi:</strong> @ve.Address"
        }

        /* INIT LODGES  */
        @foreach (Lodge l in ViewData["lodges"] as IEnumerable<Lodge>)
        {
		<text>
        var position = new google.maps.LatLng("@l.Latitude", "@l.Longitude");
        var distance = google.maps.geometry.spherical.computeDistanceBetween(lodges[-1].data, position);
        var des = "<table class='table table-hover'>";
        des += "<tr><th>Tổ chức từ thiện:</th><td align='center'><a href='123'>@l.ChairitiesExam.Charity.Name</a></td></tr>";
        des += "<tr><th>Địa chỉ nhà trọ:</th><td>@l.Address</td></tr>";
        des += "<tr><th>Khoảng cách đến nơi thi:</th><td align='center'>" + Math.round(distance) + " mét</td></tr>";
        des += "<tr><th>Tổng số chỗ:</th><td align='center'>@l.TotalSlots</td></tr>";
        des += "<tr><th>Số chỗ còn trống:</th><td align='center'>@l.AvailableSlots</td></tr>";
        des += "<tr><td align='center' colspan='2'>";
        @if (l.AvailableSlots > 0) {
            <text>des += "<button onclick='return prepareToSubmit(@l.LodgeID)' class='btn-u btn-u-blue'>Đăng kí vào nhà trọ này!</button>&nbsp;";</text>
        }
        des += "<button onclick='currentInfoWindow.close()' class='btn-u btn-u-blue'>Đóng</button></td></tr></table>";

        lodges[@l.LodgeID] = {
            lodgeId: @l.LodgeID,
            ceId: @l.CharityExamID,
            name: "@l.Address",
            data: position,
            d: distance, // distance to exam venue.
            totalSlots: @l.TotalSlots,
            availSlots: @l.AvailableSlots,
            description: des,
        }
        </text>
        }
    }
</script>
